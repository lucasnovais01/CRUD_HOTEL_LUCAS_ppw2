-- ######################################################################
-- #              DDL ESTRUTURAL (VERSÃO FINAL CONSOLIDADA)             #
-- ######################################################################
-- Autor: LUCAS NOVAIS DE OLIVEIRA
-- SISTEMA DE HOTELARIA "COCAO HOTEL"
-- ######################################################################

-- 0.  LIMPEZA DE OBJETOS ANTERIORES
-- LIMPEZA (Ordem FILHO -> PAI - SEQUÊNCIA DE DROP CORRIGIDA)
-- ------------------------------
DROP TABLE COCAO_HOSPEDE_SERVICO;
DROP TABLE COCAO_RESERVA; 
DROP TABLE COCAO_QUARTO;
DROP TABLE COCAO_SERVICO;
DROP TABLE COCAO_FUNCIONARIO;
DROP TABLE COCAO_HOSPEDE;
DROP TABLE COCAO_FUNCAO; 
DROP TABLE COCAO_USUARIO;
-----------------------------------------------------------------------------------------

-- 1. CATÁLOGO DE FUNÇÕES/CARGOS (1:N com COCAO_FUNCIONARIO)
-----------------------------------------------------------------------------------------
CREATE TABLE COCAO_FUNCAO (
    ID_FUNCAO INTEGER GENERATED BY DEFAULT AS IDENTITY,
    CODIGO CHAR(4) NOT NULL,
    NOME_FUNCAO VARCHAR2(60) NOT NULL,
    DESCRICAO VARCHAR2(200),
    NIVEL_ACESSO NUMBER(1) NOT NULL CHECK (NIVEL_ACESSO BETWEEN 1 AND 3),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,

    -- PRIMARY KEY
    CONSTRAINT PK_COCAO_FUNCAO PRIMARY KEY (ID_FUNCAO),
    
    -- UNIQUE KEY
    CONSTRAINT UK_COCAO_FUNCAO_CODIGO UNIQUE (CODIGO),
    CONSTRAINT UK_COCAO_FUNCAO_NOME UNIQUE (NOME_FUNCAO)
);
-----------------------------------------------------------------------------------------
-- 2. SUPERCLASSE USUÁRIO (TIPO ALTERADO PARA 0/1 com DEFAULT 0)
-----------------------------------------------------------------------------------------
CREATE TABLE COCAO_USUARIO (
    ID_USUARIO INTEGER GENERATED BY DEFAULT AS IDENTITY,
    NOME_USUARIO VARCHAR2(100) NOT NULL,
    CPF CHAR(11) NOT NULL,
    RG VARCHAR2(20),
    SEXO CHAR(1) NOT NULL CHECK (SEXO IN ('M','F')),
    DATA_NASCIMENTO DATE NOT NULL,
    EMAIL VARCHAR2(100),
    TELEFONE VARCHAR2(20),
    TIPO NUMBER(1) DEFAULT 0 NOT NULL CHECK (TIPO IN (0, 1)), -- 0=Hóspede (Default), 1=Funcionário
    ATIVO NUMBER(1) DEFAULT 1 CHECK (ATIVO IN (1, 0)),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,

    -- PRIMARY KEY
    CONSTRAINT PK_COCAO_USUARIO PRIMARY KEY (ID_USUARIO),
    
    -- UNIQUE KEY
    CONSTRAINT UK_COCAO_USUARIO_CPF UNIQUE (CPF),
    CONSTRAINT UK_COCAO_USUARIO_EMAIL UNIQUE (EMAIL),
    
    -- CHECK CONSTRAINT
    CONSTRAINT CHK_COCAO_CPF_FORMATO CHECK (REGEXP_LIKE(CPF, '^[0-9]{11}$')),
    CONSTRAINT CHK_COCAO_EMAIL_FORMATO CHECK (EMAIL IS NULL OR REGEXP_LIKE(EMAIL, '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$')),
    CONSTRAINT CHK_COCAO_TELEFONE_FORMATO CHECK (TELEFONE IS NULL OR REGEXP_LIKE(TELEFONE, '^[0-9\s\-\(\)]+$')),
    CONSTRAINT CHK_COCAO_DATA_NASCIMENTO_MIN CHECK (DATA_NASCIMENTO >= TO_DATE('1900-01-01','YYYY-MM-DD'))
    -- Validações dinâmicas via Trigger.
);
-----------------------------------------------------------------------------------------
-- 3. HÓSPEDE (Subclasse)
-----------------------------------------------------------------------------------------
CREATE TABLE COCAO_HOSPEDE (
    ID_USUARIO INTEGER,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    -- PRIMARY KEY
    CONSTRAINT PK_COCAO_HOSPEDE PRIMARY KEY (ID_USUARIO),
    
    -- FOREIGN KEY
    CONSTRAINT FK_COCAO_HOSPEDE_USUARIO FOREIGN KEY (ID_USUARIO)
        REFERENCES COCAO_USUARIO(ID_USUARIO)
    -- Exclusividade mútua e consistência de TIPO=0 via Trigger.
);
-----------------------------------------------------------------------------------------
-- 4. FUNCIONÁRIO (Subclasse) - ID_FUNCAO agora é NULO
-----------------------------------------------------------------------------------------
CREATE TABLE COCAO_FUNCIONARIO (
    ID_USUARIO INTEGER,
    -- CORREÇÃO: ID_FUNCAO É NULO PARA PERMITIR CONTRATAÇÃO ANTES DA ATRIBUIÇÃO DE FUNÇÃO.
    ID_FUNCAO INTEGER, 
    DATA_CONTRATACAO DATE NOT NULL,
    NOME_LOGIN VARCHAR2(50) NOT NULL,
    SENHA VARCHAR2(200) NOT NULL, 
    ATIVO NUMBER(1) DEFAULT 1 CHECK (ATIVO IN (1, 0)),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    -- PRIMARY KEY
    CONSTRAINT PK_COCAO_FUNCIONARIO PRIMARY KEY (ID_USUARIO),
    
    -- FOREIGN KEYS
    CONSTRAINT FK_COCAO_FUNCIONARIO_USUARIO FOREIGN KEY (ID_USUARIO)
        REFERENCES COCAO_USUARIO(ID_USUARIO),
    CONSTRAINT FK_COCAO_FUNCIONARIO_FUNCAO FOREIGN KEY (ID_FUNCAO)
        REFERENCES COCAO_FUNCAO(ID_FUNCAO),
        
    -- UNIQUE KEY
    CONSTRAINT UK_COCAO_FUNCIONARIO_LOGIN UNIQUE (NOME_LOGIN)
    -- Exclusividade mútua, consistência de TIPO=1 e Data Contratação via Trigger.
);
-----------------------------------------------------------------------------------------
-- 5. QUARTO (Catálogo)
-----------------------------------------------------------------------------------------
CREATE TABLE COCAO_QUARTO (
    ID_QUARTO INTEGER GENERATED BY DEFAULT AS IDENTITY,
    NUMERO NUMBER NOT NULL,
    TIPO_QUARTO VARCHAR2(50) NOT NULL,
    VALOR_DIARIA NUMBER(10,2) NOT NULL CHECK (VALOR_DIARIA > 0),
    STATUS_QUARTO VARCHAR2(20) DEFAULT 'LIVRE'
        CHECK (STATUS_QUARTO IN ('LIVRE','OCUPADO','MANUTENCAO')),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    -- PRIMARY KEY
    CONSTRAINT PK_COCAO_QUARTO PRIMARY KEY (ID_QUARTO),
    
    -- UNIQUE KEY
    CONSTRAINT UK_COCAO_QUARTO_NUMERO UNIQUE (NUMERO)
    -- Sincronização de STATUS_QUARTO via Trigger.
);
-----------------------------------------------------------------------------------------
-- 6. SERVIÇO (Catálogo)
-----------------------------------------------------------------------------------------
CREATE TABLE COCAO_SERVICO (
    ID_SERVICO INTEGER GENERATED BY DEFAULT AS IDENTITY,
    NOME_SERVICO VARCHAR2(100) NOT NULL,
    DESCRICAO VARCHAR2(500),
    PRECO NUMBER(10,2) NOT NULL CHECK (PRECO >= 0),
    ATIVO NUMBER(1) DEFAULT 1 CHECK (ATIVO IN (1, 0)),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    -- PRIMARY KEY
    CONSTRAINT PK_COCAO_SERVICO PRIMARY KEY (ID_SERVICO),
    
    -- UNIQUE KEY
    CONSTRAINT UK_COCAO_SERVICO_NOME UNIQUE (NOME_SERVICO)
);
-----------------------------------------------------------------------------------------
-- 7. RESERVA (N:1 com HOSPEDE, N:1 com QUARTO)
-----------------------------------------------------------------------------------------
CREATE TABLE COCAO_RESERVA (
    ID_RESERVA INTEGER GENERATED BY DEFAULT AS IDENTITY,
    DATA_CHECK_IN DATE NOT NULL,
    DATA_CHECK_OUT DATE NOT NULL,
    VALOR_TOTAL NUMBER(10,2) DEFAULT 0 CHECK (VALOR_TOTAL >= 0),
    STATUS_RESERVA VARCHAR2(20) DEFAULT 'ABERTA'
        CHECK (STATUS_RESERVA IN ('ABERTA','ATIVA','FINALIZADA','CANCELADA')),
    ID_USUARIO INTEGER NOT NULL,
    ID_QUARTO INTEGER NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    -- PRIMARY KEY
    CONSTRAINT PK_COCAO_RESERVA PRIMARY KEY (ID_RESERVA),
    
    -- FOREIGN KEYS
    CONSTRAINT FK_COCAO_RESERVA_HOSPEDE FOREIGN KEY (ID_USUARIO)
        REFERENCES COCAO_HOSPEDE(ID_USUARIO),
    CONSTRAINT FK_COCAO_RESERVA_QUARTO FOREIGN KEY (ID_QUARTO)
        REFERENCES COCAO_QUARTO(ID_QUARTO),
        
    -- CHECK CONSTRAINT
    CONSTRAINT CHK_COCAO_DATAS_RESERVA CHECK (DATA_CHECK_OUT > DATA_CHECK_IN)
    -- Conflito de datas (sobreposição) via Trigger.
);
-----------------------------------------------------------------------------------------
-- 8. HOSPEDE_SERVICO (N:M Refatorada)
-----------------------------------------------------------------------------------------
CREATE TABLE COCAO_HOSPEDE_SERVICO (
    ID_SOLICITACAO INTEGER GENERATED BY DEFAULT AS IDENTITY,
    ID_USUARIO INTEGER NOT NULL,
    ID_SERVICO INTEGER NOT NULL,
    DATA_SOLICITACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    QUANTIDADE NUMBER DEFAULT 1 CHECK (QUANTIDADE > 0),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    -- PRIMARY KEY
    CONSTRAINT PK_COCAO_HS_SOLICITACAO PRIMARY KEY (ID_SOLICITACAO),
    
    -- FOREIGN KEYS
    CONSTRAINT FK_COCAO_HS_HOSPEDE FOREIGN KEY (ID_USUARIO)
        REFERENCES COCAO_HOSPEDE(ID_USUARIO),
    CONSTRAINT FK_COCAO_HS_SERVICO FOREIGN KEY (ID_SERVICO)
        REFERENCES COCAO_SERVICO(ID_SERVICO),
        
    -- UNIQUE KEY (Garante no máximo uma solicitação do mesmo serviço por dia por hóspede)
    CONSTRAINT UK_COCAO_HS_UNICA_SOLICITACAO UNIQUE (ID_USUARIO, ID_SERVICO, TRUNC(DATA_SOLICITACAO))
);
-----------------------------------------------------------------------------------------
-- FIM DO DDL